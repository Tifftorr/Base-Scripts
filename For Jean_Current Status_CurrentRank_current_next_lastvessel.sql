/*select top 10 * from  shipsure.dbo.CRWSrvDetaiL
select top 10 * from shipsure..CRWMovementTypes*/

Use shipsure
go

 create table #tmpVessels(  
					 VES_ID varchar(12),  
					 VES_Name varchar(128),  
					 ves_ownergrp varchar(12),  
					 ves_onboard2 int default 0,  
					 Client varchar(128),
					 VTY_ID varchar(12) NULL,
					 VMO_ID varchar(12) NULL,
					 SMO_ID varchar(12) NULL,
					 VESSEL_IMO VARCHAR(8) NULL,
					 SMO_OFFICE VARCHAR(256) NULL,
					 VESSEL_TYPE VARCHAR(256) NULL,
					 VESSEL_GENERAL_TYPE VARCHAR(256) NULL,
					 VESSEL_GENERAL_SUB_TYPE VARCHAR(256) NULL
		 ) 
		

		INSERT INTO #tmpVessels
		SELECT	v.VES_ID, ves_name, null as ves_ownergrp, ves_onboard2, null as  Client, 
				V.VTY_ID, vd.VMO_ID AS VMO_ID, 
				COALESCE(VES_OFFTECH,VES_RespOff)  AS SMO, 
				VES_ImoNumber as VESSEL_IMO, GS.SIT_NAME AS SMO_OFFICE,
				VTY.VTY_Desc AS VESSEL_TYPE,
		CASE	WHEN VTY.VTY_ID = 'OTH' THEN 'CARGO'
				WHEN VTY.VTY_ID = 'OV' THEN 'OFFSHORE'
				WHEN VTY.VTY_ID = 'SLG' THEN 'CARGO'
				WHEN VTY.VTY_ID = 'UN' THEN 'CARGO'
				WHEN VTY.VTY_ID = 'LIV' THEN 'CARGO'
				WHEN VTY.VTY_ID = 'WF' THEN 'CARGO'
				WHEN VTY.VTY_ID = 'TH' THEN 'CARGO'
				WHEN VTY.VTY_ID = 'TG' THEN 'CARGO'
				WHEN VTY.VTY_ID = 'TGE' THEN 'CARGO'
				WHEN VTY.VTY_ID = 'RF' THEN 'CARGO'
				WHEN VTY.VTY_ID = 'WA' THEN 'CARGO'
				WHEN VTY.VTY_ID = 'WB' THEN 'CARGO'
				WHEN VTY.VTY_ID = 'WD' THEN 'CARGO'
				WHEN VTY.VTY_ID = 'NHTANK' THEN 'CARGO'
				WHEN VTY.VTY_ID = 'O/O' THEN 'CARGO'
				WHEN VTY.VTY_ID = 'PTANK' THEN 'CARGO'
				WHEN VTY.VTY_ID = 'TANKER' THEN 'CARGO'
				WHEN VTY.VTY_ID = 'TD' THEN 'CARGO'
				WHEN VTY.VTY_ID = 'TNB' THEN 'CARGO'
				WHEN VTY.VTY_ID = 'TNS' THEN 'CARGO'
				WHEN VTY.VTY_ID = 'TNV' THEN 'CARGO'
				WHEN VTY.VTY_ID = 'TO' THEN 'CARGO'
				WHEN VTY.VTY_ID = 'TR' THEN 'CARGO'
				WHEN VTY.VTY_ID = 'CASINO' THEN 'LEISURE'
				WHEN VTY.VTY_ID = 'HOVER' THEN 'LEISURE'
				WHEN VTY.VTY_ID = 'HSC' THEN 'LEISURE'
				WHEN VTY.VTY_ID = 'HYDRO' THEN 'LEISURE'
				WHEN VTY.VTY_ID = 'LAUNCH' THEN 'LEISURE'
				WHEN VTY.VTY_ID = 'PFERRY' THEN 'LEISURE'
				WHEN VTY.VTY_ID = 'PN' THEN 'LEISURE'
				WHEN VTY.VTY_ID = 'PNSMD' THEN 'LEISURE'
				WHEN VTY.VTY_ID = 'PSC' THEN 'LEISURE'
				WHEN VTY.VTY_ID = 'VFERRY' THEN 'LEISURE'
				WHEN VTY.VTY_ID = 'VHOVER' THEN 'LEISURE'
				WHEN VTY.VTY_ID = 'YAT' THEN 'LEISURE'
				WHEN VTY.VTY_ID = 'HVL' THEN 'OFFSHORE'
				WHEN VTY.VTY_ID = 'LN' THEN 'OFFSHORE'
				WHEN VTY.VTY_ID = 'TUG' THEN 'OFFSHORE'
				WHEN VTY.VTY_ID = 'ACO' THEN 'OFFSHORE'
				WHEN VTY.VTY_ID = 'ACSS' THEN 'OFFSHORE'
				WHEN VTY.VTY_ID = 'CGRV' THEN 'OFFSHORE'
				WHEN VTY.VTY_ID = 'CON' THEN 'OFFSHORE'
				WHEN VTY.VTY_ID = 'DRILL' THEN 'OFFSHORE'
				WHEN VTY.VTY_ID = 'DSV' THEN 'OFFSHORE'
				WHEN VTY.VTY_ID = 'DSVS' THEN 'OFFSHORE'
				WHEN VTY.VTY_ID = 'FPSO' THEN 'OFFSHORE'
				WHEN VTY.VTY_ID = 'FSO' THEN 'OFFSHORE'
				WHEN VTY.VTY_ID = 'FSV' THEN 'OFFSHORE'
				WHEN VTY.VTY_ID = 'HVLO' THEN 'OFFSHORE'
				WHEN VTY.VTY_ID = 'IMRV' THEN 'OFFSHORE'
				WHEN VTY.VTY_ID = 'JUU' THEN 'OFFSHORE'
				WHEN VTY.VTY_ID = 'MODU' THEN 'OFFSHORE'
				WHEN VTY.VTY_ID = 'MOU' THEN 'OFFSHORE'
				WHEN VTY.VTY_ID = 'OA' THEN 'OFFSHORE'
				WHEN VTY.VTY_ID = 'OSB' THEN 'OFFSHORE'
				WHEN VTY.VTY_ID = 'OSHORE' THEN 'OFFSHORE'
				WHEN VTY.VTY_ID = 'OSR' THEN 'OFFSHORE'
				WHEN VTY.VTY_ID = 'OTUG' THEN 'OFFSHORE'
				WHEN VTY.VTY_ID = 'PATB' THEN 'OFFSHORE'
				WHEN VTY.VTY_ID = 'PIP' THEN 'OFFSHORE'
				WHEN VTY.VTY_ID = 'PPU' THEN 'OFFSHORE'
				WHEN VTY.VTY_ID = 'PSV' THEN 'OFFSHORE'
				WHEN VTY.VTY_ID = 'RIG' THEN 'OFFSHORE'
				WHEN VTY.VTY_ID = 'SB' THEN 'OFFSHORE'
				WHEN VTY.VTY_ID = 'SBY' THEN 'OFFSHORE'
				WHEN VTY.VTY_ID = 'SEI' THEN 'OFFSHORE'
				WHEN VTY.VTY_ID = 'SPJU' THEN 'OFFSHORE'
				WHEN VTY.VTY_ID = 'SRV' THEN 'OFFSHORE'
				WHEN VTY.VTY_ID = 'SVG' THEN 'OFFSHORE'
				WHEN VTY.VTY_ID = 'TU' THEN 'OFFSHORE'
				WHEN VTY.VTY_ID = 'UTV' THEN 'OFFSHORE'
				WHEN VTY.VTY_ID = 'WIU' THEN 'OFFSHORE'
				WHEN VTY.VTY_ID = 'AcOfSh' THEN 'OFFSHORE'
				WHEN VTY.VTY_ID = 'ICEB' THEN 'OFFSHORE'
				WHEN VTY.VTY_ID = 'TDP' THEN 'OFFSHORE'
				WHEN VTY.VTY_ID IS NULL THEN NULL
				ELSE 'CARGO'
		END AS VESSEL_GENERAL_TYPE,
				bb.VGT_Desc as VESSEL_GENERAL_SUB_TYPE-- added 20.05
		FROM	vessel v  
		LEFT JOIN company c (NOLOCK) on c.cmp_id = v.ves_ownergrp  
		LEFT JOIN GLOBALSITE GS (NOLOCK) on GS.SIT_ID  = v.VES_OffTech 
		LEFT JOIN VESTYPE VTY (NOLOCK) ON VTY.VTY_ID = V.VTY_ID
		inner join VESGENTYPE bb  on vty.VTY_GenType = bb.VGT_ID-- added 20.05
		INNER join vesmanagementdetails vd   on v.ves_id=vd.ves_id and (vmd_manageend>=getdate() or vmd_manageend is null) and (VMD_Deleted is null or VMD_Deleted=0) 

		CREATE NONCLUSTERED INDEX ix_tempNCIndexAft ON #tmpVessels (ves_id);


Select 
sd.CRW_ID,
pd.crw_pid as PCN,
sts.sts_desc as [Current Status],
coalesce(sd.rnk_id_budgeted,sd.rnk_id) as rnk_id,
rnk.RNK_Description as [Rank],
case when sts.STS_Desc = 'ONBOARD' then sd.VES_ID else NULL end as Current_Vessel_ID,
case when sts.STS_Desc = 'ONBOARD' then v.ves_name else NULL end as [Current_Vessel] 

into #tmpcrw
from shipsure.dbo.CRWSrvDetaiL sd
left join shipsure..CRWPersonalDetails pd on pd.crw_id = sd.CRW_ID
left join shipsure..CRWMovementTypes sts on sts.sts_id = sd.sts_id
left join shipsure..CRWRanks rnk on rnk.RNK_ID = coalesce(sd.rnk_id_budgeted,sd.rnk_id)
LEFT JOIN  VESSEL V (NOLOCK) ON SD.VES_ID = V.VES_ID
where sd.SET_Cancelled = 0
and sd.SET_PreviousExp = 0
and SET_ActiveStatus = 1
and pd.crw_PID in ('5121KRC53274',
'4111BNAV0008',
'4111NOVZ0834',
'6121MAI21728',
'4111NOVZ1502',
'41361628',
'5121MUB51889',
'6111MAI17996',
'4421ODEZ0130',
'5121MUB16549',
'6111GLS37731',
'6111MAI36610',
'26200000155',
'4111NOV10750',
'4111ODS22384',
'28400000047',
'6121MAI77961',
'6111GLS37193',
'6711MANZ1998',
'4111ODS17838',
'6121MAI33283',
'4111ODS34778',
'6121MAI59826',
'0121MUB59090',
'4121NOV02500',
'4121ODS08410',
'4121NOV02488',
'4121NOO03997',
'4721ARH24164',
'4111ROA52924',
'4111RIGA0421',
'K06304',
'6751MAI54269',
'6111PF004691',
'7121IST58615',
'6711GLS57645',
'4711GEE04174',
'4121NOVO0679',
'4111NOVO0842',
'4111ODS24928',
'26900000733',
'7111IST52437',
'4111RIA05869',
'6111MAI15049',
'0121MUB44329',
'7111IST27633',
'6121MAI23556',
'4121GDN53487',
'6121MAI28335',
'6111MAI30375',
'4121ODES0450',
'4121NOVZ0410',
'4121ODEZ2972',
'4111NOVZ0169',
'4111NOV10792',
'4111NOVO0606',
'6121MAI36196',
'7111ITD16757',
'6121MAI68342',
'6121SIG17529',
'4111NOV06749',
'4121NOV08927',
'4121NOVO0922',
'4121ODS09441',
'4711NOO04079',
'26900000877',
'6111MAI38365',
'4121ODEZ3107',
'4111NOO04185',
'4111ODES0508',
'4711GLAT0974',
'4111NOO03825',
'4111GDN53509',
'4121RIA08775',
'4121NOO04033',
'0741MUB04223',
'4121STE06043',
'6121MAI92216',
'4121ODS17377',
'4711ODEZ2387',
'0121MUMB0751',
'4711ODS13554',
'6711MAI27025',
'4121RIA05921',
'4111PF018734',
'4121ODS13555',
'41179595',
'41061365',
'K06236',
'6721PF031501',
'4121NOV12774',
'01094513',
'4121NOV06157',
'5121MUB09499',
'4121NOV06228',
'4111GLS10254',
'4111ODES0934',
'0121MUB46308',
'4121GLS57812',
'6121MAI60755',
'4111RIA08371',
'3056',
'4111NOV09624',
'4121NOV10588',
'4111BTM36202',
'4111ODES0594',
'7121IST55437',
'4121RIA06065',
'4111NOVO0609',
'K06443',
'4111NOO02104',
'4111RIA05003',
'4121RIA05969',
'4121NOO03296',
'4111NOO03334',
'4111MONA0379',
'4121ODS12421',
'41069099',
'K06183',
'4111ODS36652',
'4111SAM07319',
'4111ODS30140',
'4111NOV08466',
'4711STE34686',
'4111GDN55706',
'4121ODS34408',
'4121STE55651',
'0121MUB09029',
'6721MAI62979',
'4121NOO03816',
'4111ARH07672',
'6111MAI19645',
'4121NOV08616',
'4121NOO03930',
'0121MUB13118',
'4111NOV02521',
'4121GLS08793',
'4111NOV11429',
'5121SING0617',
'4111NOV14478',
'4121NOV06211',
'4121NOV10288',
'4121NOV12717',
'K04013',
'6111MAI89503',
'4121NOO03513',
'4721NOVO0914',
'0121MUB09326',
'6121MAI16556',
'4111PF017544',
'0111MUB37758',
'4121ODEZ3090',
'9121PF033779',
'6111MAI52833',
'4121NOVZ1030',
'4121NOO04976',
'4111NOO03090',
'4111NOV06137',
'4121ODES0791',
'4111ODS16854',
'4111TBI09203',
'4111NOVO0274',
'5121MUB12338',
'4121ODS17151',
'4111GDN53580',
'41071034',
'6121MAI22193',
'6121PF026812',
'6121PF014381',
'4991STPZ1046',
'8925',
'4121NOV07013',
'4111NOO03377',
'4121STE04117',
'6111MAI73716',
'6121MAI29362',
'4411NOVZ2055',
'4111LIA01526',
'4711NOVZ1435',
'4111NOO04044',
'6711MAI52008',
'41368649',
'6121MAI08504',
'4111NOV11799',
'K06054',
'6121MAI28505',
'4721NOO03909',
'41AANOV07458',
'4111ODS11654',
'4121ODS58701',
'4121ROA28305',
'6114MYN09144',
'5121MUB32145',
'K05675',
'6111MAI27040',
'4111ODEZ1111',
'6721MAI48973',
'6121MAI34007',
'4711RIA06537',
'4121NOV06556',
'4121GDN53607',
'4111MUB19998',
'4111NOVZ1195',
'4711NOV05665',
'47359013',
'4121NOV08236',
'4111PF028021',
'4111NOO03761',
'4111NOO03817',
'4111NOV05955',
'4111NOO04225',
'4111GLS01815',
'4111ODS08262',
'4111NOV11353',
'4121NOO04390',
'4111STE06907',
'4111ODS53895',
'0121MUB09469',
'62310364',
'4111NOV09992',
'4121NOO04077',
'4111GDN53615',
'4111GDN53617',
'6111MAI65477',
'4111ODS11488',
'5111KRC54578',
'4121BTM33445',
'6121MANZ1187',
'4111NOO03923',
'4111STE05039',
'4111NOV07728',
'6111MAI50310',
'4121ODS17937',
'4121TBI05901',
'5111ARH29738',
'4738MUB47947',
'4111GLS04711',
'4751ODS20490',
'4111ODS20324',
'4121GLS09786',
'4111SAM48806',
'4721NOV12292',
'4114GDN28454',
'6121MAI27652',
'4121ABD00238',
'4121NOV02525',
'4121NOV06565',
'4111NOV07183',
'K05810',
'4121NOV05982',
'4121ODEZ2893')

SELECT *
		INTO #NEXT_VESSEL
		FROM (
				SELECT DISTINCT TC.CRW_ID, CSA.CSA_Description AS PlanningStatus, sd.ves_id as Next_Vessel_ID,TV.VES_NAME AS NEXT_VESSEL, 
								TV.CLIENT AS NEXT_VESSEL_CLIENT, case when VV.VMO_ID='GLAS00000003' then 'Full Management' else VV.VMO_Desc  end as VMO_DESC, TV.SMO_OFFICE, TV.VESSEL_TYPE, 
								TV.VESSEL_GENERAL_TYPE, TV.VESSEL_GENERAL_SUB_TYPE,
								cast(SD.SET_STARTDATE as date) AS PLAN_TO_JOIN,
								TV.VESSEL_IMO AS NEXT_VESSEL_IMO, 
								DENSE_RANK() OVER (
													PARTITION BY TC.CRW_ID
													ORDER BY SET_STARTDATE, SET_UpdatedOn ASC) LV
		FROM	#tmpcrw TC   
		INNER JOIN CRWSRVDETAIL SD (NOLOCK) ON SD.CRW_ID = TC.CRW_ID 
		INNER JOIN CRWAssignedStatus  CSA ON CSA.CSA_ID = SD.CSA_ID
		LEFT JOIN #tmpVessels TV ON TV.VES_ID = SD.VES_ID
		LEFT JOIN DBO.VesManOffType VV ON VV.VMO_ID = TV.VMO_ID 
		WHERE SET_ACTIVESTATUS = 0
		AND		SAS_ID = 3 
		AND		SET_CANCELLED = 0
		AND		STS_ID = 'OB'
		AND		SGT_ID IS NULL
		AND		SD.VES_ID IS NOT NULL
		AND		SD.CRW_ID IS NOT NULL
		AND		SD.CSA_ID IN ('VSHP00000001', 'VSHP00000002','VSHP00000004','VSHP00000011','VSHP00000013')
		) AA
		WHERE LV = 1 
		order by 1

		--GET LAST VESSEL			
		SELECT  *
		INTO #LAST_VESSEL
		FROM (
				SELECT DISTINCT TC.CRW_ID, sd.ves_id as LAST_VESSEL_ID,TV.VES_NAME AS LAST_VESSEL, TV.CLIENT AS LAST_VESSEL_CLIENT, set_startdate, set_enddate as LastSignOff,
								TV.VESSEL_IMO AS LAST_VESSEL_IMO,   case when VV.VMO_ID='GLAS00000003' then 'Full Management' else VV.VMO_Desc  end as VMO_DESC , TV.SMO_OFFICE, TV.VESSEL_TYPE, TV.VESSEL_GENERAL_TYPE, TV.VESSEL_GENERAL_SUB_TYPE,
				DENSE_RANK() OVER (
									PARTITION BY TC.CRW_ID
									ORDER BY SET_STARTDATE desc, sd.set_updatedon desc, sd.set_id asc) LV
		FROM #tmpcrw TC   
		INNER JOIN CRWSRVDETAIL SD ON SD.CRW_ID = TC.CRW_ID
		LEFT JOIN #tmpVessels TV ON TV.VES_ID = SD.VES_ID
		LEFT JOIN DBO.VesManOffType VV ON VV.VMO_ID = TV.VMO_ID 
		WHERE SAS_ID = 2 
		AND SET_ACTIVESTATUS = 0
		AND SET_CANCELLED = 0
		AND STS_ID = 'OB'
		AND	SET_PreviousExp = 0
		AND SD.VES_ID IS NOT NULL
		AND SGT_ID IS NOT NULL
		) AA
		WHERE LV = 1 


		select

		tc.*,
		nv.next_vessel_id,
		nv.next_vessel,
		lv.last_vessel_id,
		lv.last_vessel,
		coalesce(tc.Current_Vessel, next_vessel, last_vessel) as [Vessel]

		from #tmpCrw tc
		left join #next_vessel nv on NV.CRW_ID = TC.CRW_ID
		left join #last_vessel lv on lv.crw_id = tc.crw_ID


		drop table #tmpcrw
		drop table #tmpVessels
		drop table #next_vessel
		drop table #last_vessel