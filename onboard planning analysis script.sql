WITH Offsigners AS (

SELECT DISTINCT
	SD.[Crew ID],
	PD.[Crew PID] as PCN,
	SD.[Service Record ID],
	CASE WHEN SD.[Service Active Status ID] = 1 THEN 'Onboard'
		 WHEN SD.[Service Active Status ID] = 2 THEN 'History'
		 WHEN SD.[Service Active Status ID] = 3 THEN 'Planned'
		 ELSE 'Unmapped'
	END AS [Crew Movement Status],
	SD.[End Date] as [Activity Date],
	SD.[Start Date],
	SD.[End Date],
	ISNULL(SD.[Rank ID], SD.[Rank ID Budgeted]) as [Crew Rank ID],
	ISNULL(SD.[Rank], SD.[Rank Budgeted]) AS [Crew Rank],
	P.[Port Name] as [Load Port],
	CT.[Country Name] as [Load Port Country],
	SD.[Vessel ID],
	PD.[Mobilisation Cell ID],
	PD.[Planning Cell ID],
	pd.[CMP Cell ID],
	SGT.[SignOff Reason],
	'Signoff' [Action]

FROM [ShipMgmt_Crewing].[tCrewServiceRecords] SD (NOLOCK)
INNER JOIN [ShipMgmt_Crewing].[tCrew] PD (NOLOCK) ON PD.[Crew ID] = SD.[Crew ID]
LEFT JOIN [Reference_Position].[tPort] P (NOLOCK) ON P.[Port ID] = SD.[Disport ID]
LEFT JOIN [Reference_Position].[tCountry] CT (NOLOCK) ON CT.[Country ID] = P.[Country ID]
OUTER APPLY (SELECT TOP (1) VMS.[Vessel Mgmt ID], VMS.[Vessel Name], VMS.[Vessel Mgmt Type], VMS.[Client ID]
				FROM [ShipMgmt_VesselMgmt].[tShipMgmtRecords] vms (nolock)  
				WHERE VMS.[Vessel ID] = SD.[Vessel ID]
					AND CAST(SD.[End Date] as DATE) BETWEEN vms.[Mgmt Start] AND ISNULL(vms.[Mgmt End], GETDATE())					
				ORDER BY COALESCE(vms.[Mgmt Start], vms.[Purchasing Start Date]) DESC) VMS
LEFT JOIN [ShipMgmt_Crewing].[tCrewSignOffType] SGT (NOLOCK) ON SGT.[SignOff Reason ID] = SD.[Sign Off Reason ID]
LEFT JOIN [ShipMgmt_Crewing].[tCrewRanks] RNK (NOLOCK) ON RNK.[Rank ID] = SD.[Rank ID]
OUTER APPLY (SELECT TOP (1) Tech.[Office Name]
			 FROM [ShipMgmt_VesselMgmt].[tShipMgmtRecordsOffices] TECH
			 WHERE TECH.[Vessel Mgmt ID] = VMS.[Vessel Mgmt ID]
			 AND TECH.[Office Type] = 'Technical Office'
			 AND CAST(SD.[End Date] as DATE) BETWEEN TECH.[Valid From] AND ISNULL(TECH.[Valid To], GETDATE())
			 ORDER BY TECH.[VALID FROM] DESC) Tech
LEFT JOIN [Reference_Vessel].[tVessel] VV ON VV.[Vessel ID] = SD.[VESSEL ID]
LEFT JOIN [Reference_BusinessStructure].[tCompany] CL ON CL.[Company ID] = VMS.[Client ID]
WHERE SD.[Service Cancelled] = 0
	AND SD.[Previous Experience] = 0
	AND (SD.[Service Active Status ID] is null or SD.[Service Active Status ID] <> (3) )
	AND SD.[Status ID] in ('OB','OV')
	and SD.[End Date] <= GETDATE()
	AND SD.[Active Status] = 0
	AND CAST(SD.[End Date] AS DATE) BETWEEN  DATEADD(day,-180,getdate()) AND GETDATE()
	AND PD.[Crew PID] in ('6121PF013499',
'4121NOV02540',
'4421NOVO0473',
'4111NOV43749',
'4111NOV08776',
'4121NOV09108',
'MPS08086',
'6121XSG01536',
'6111XSG01189',
'6721PF009411',
'6121MAI37970',
'8121RIA73736',
'6711MAI42098',
'6121LIA01093',
'6711MAI19042',
'5111MAI36640',
'6121MAI15071',
'6111MAI67813',
'5111MAI44941',
'7121GLS66055',
'6121MAI83165',
'B0715BMS',
'6121PF024929',
'6711MAI12945',
'6121XSG01493',
'6111XSG01762',
'CST700001609',
'6121MAI36884',
'6111XSG00411',
'5121MAI26522',
'F1869PHL',
'5111SIG14927',
'6111MAI68761',
'6121XSG00356',
'6991GLS40000',
'6121XSG00071',
'6121MAI31053',
'6111MAI38510',
'F1467PHL',
'5111MAI27441',
'6121MAI78490',
'6111MAI80562',
'6121MAI32029',
'6721MAI15563',
'6111XSG01072',
'6121MAI54439',
'5111MAI46875',
'CST700000964',
'5111MAI47792',
'6121MAI31246',
'6721MAI08303',
'CST700000818',
'6711MAI43036',
'6121MAI67809',
'6121XSG00094',
'6121MAI25819',
'5121MAI22600',
'6111PF033964',
'6121PF021517',
'5121MAI48271',
'5111KRC52978',
'6111MAI14486',
'NRS_UD336369',
'5121MAI30393',
'5121MAI43040',
'5111MAI22777',
'5121MAI48390',
'6121MAI47319',
'6111PF017280',
'4121GLS57845',
'6111MAI84401',
'5111MAI17362',
'6111XSG00690',
'6121PF013289',
'6111PF009493',
'5114SHH48393',
'5121SHH48456',
'4121GLS47436',
'6121PF021237',
'6121MAI35593',
'6111MAI10516',
'5111MAI48170',
'6111XSG01115',
'6121XSG00317',
'6121XSG01545',
'0121MUB33106',
'6111XSG00402',
'0111MUB32927',
'0121MUB89992',
'CST700001058',
'5111MAI30542',
'0121MUB36524',
'6121MAI13957',
'0111MUB56798',
'0121MUB90960',
'4111NOV14458',
'0111MUB17736',
'0121MUB46184',
'41370732',
'4121BTM14922',
'6121GLS39189',
'6121XSG00104',
'5111MAI42844',
'4121BTM61446',
'6121PF031397',
'6121XSG00406',
'F1939PHL',
'6721XSG00539',
'4138GLS45751',
'6111PF019378',
'6721MANI0435',
'5111SIG47198',
'8111BRZ62522',
'6121XSG00111',
'4111MONA0379',
'4121NOO03237',
'4121NOO06397',
'4111NOVZ0970',
'4111ODS36414',
'9111PF026984',
'4111NOVO0819',
'4111NOV33893',
'4121NOV11012',
'4121NOV10811',
'4111NOV09893',
'4111NOVO0554',
'4111GLS56780',
'4121NOV11518',
'4121NOV10221',
'4111NOV08850',
'4721BTM24519',
'4121NOV06041',
'8111BRZ44205',
'4721NOV12292',
'9121PF021322',
'4121NOVZ1184',
'4711STPE0138',
'8111BRZ67593',
'0111VGI50009',
'8121BRZ95648',
'8111BRZ67592',
'4111SAM23460',
'8111BRZ77236',
'4121BTM10800',
'K05296',
'0121MUB04436',
'4111RIA09857',
'4121ODS08997',
'4111NOO05283',
'4711ODS21214',
'SEL46010108',
'0121MUB40613',
'4121NOV11318',
'4111ODS09032',
'4121NOVO0316',
'4111BTM51877',
'4111NOVZ1191',
'4411NOVZ2053',
'4111BTM39963',
'4121NOO10402',
'7111PF019304',
'4111NOV08008',
'4111HEL02264',
'0121MUB81299',
'SEL0V01338',
'0111MUB26070',
'0121MUB35449',
'0111MUB08944',
'4111ODS83671',
'0111MUB68504',
'6111MAI34362',
'6721MAI70324',
'4121MAI14342',
'SEL01-00086',
'0121MUB08806',
'0121MUB18131',
'4121NOV10807',
'6121MAI54658',
'4711ODS10041',
'0121MUB86626',
'5121KRC09635',
'0121MUB58916',
'4111BTM56162',
'4121NOV12889',
'4121NOV09451',
'4121NOV56340',
'4111BUG05556',
'4111STE05113',
'0111MUB38398',
'5121MUB16549',
'4121NOV43324',
'0121MUB45046',
'67AAMAI21911',
'4121RIGA0953',
'7121PF032143',
'26900000023',
'0111MUB14824',
'4721ODS11800',
'4111NOV14376',
'6121SIG09261',
'0111MUB36809',
'4111RIA08097',
'4121RIA06661',
'4111BTM46631',
'4121RIE89174',
'5111MAI48092',
'41AANOV14311',
'4711GLS45248',
'4121ODS22200',
'0121MUB43488',
'0111MUB30954',
'B0135BMS',
'4121NOV47198',
'0121MUB56101',
'4111GLS66892',
'4121GLS63194',
'29200000036',
'6121MAI68210',
'0121MUB34105',
'4477PF003568',
'0111MUB31614',
'0121MUB88868',
'4121STE76689',
'4111NOV14293',
'0121MUB15914',
'4721PF010890',
'4111PF007034',
'4121ODS08531',
'6111MAI59625',
'0111MUB88178',
'7111GLS45179',
'4111NOO05031',
'4111TBI02615',
'6711MAI23365',
'VB6241',
'4121GLS59057',
'6111MAI48832',
'0121MUB59191',
'4111ODS30353',
'0121MUB41045',
'5111GLS90255',
'4111NOV13724',
'4111GLS01815',
'4121ODES0756',
'5121MAI49160',
'0121VGI50051',
'21414',
'5121SIG43266',
'5121MAI49110',
'4111ROA68195',
'5111MUB25998',
'26900000673',
'8111BRZ89507',
'8121BRZ80237',
'8121BRZ80941',
'7121ODS66368',
'4121GLS78069',
'9751PF020964',
'5121MAI49239',
'4111BTM55348',
'0121MUB54401',
'4721SAM06414',
'4111NOV08020',
'4121NOO02703',
'5111MUB90609',
'5111GLS91089',
'4111GLS78442',
'2111PAI78408',
'4721TAL04555',
'0121MUB37071',
'4111PAI39442',
'4721GLS50050',
'0111MUB20931',
'0111MUB35878',
'0121MUB56138',
'4121STE05378',
'0121MUB77115',
'4111BUG55682',
'7121ODS91384',
'4111NOV10059',
'4111NOVZ1500',
'4711GLS43663',
'0111MUB08843',
'4111ODS18040',
'5111MAI15927',
'2111GLS73347',
'4111PF016678',
'7111KRC55993',
'4711ODS27424',
'4421GLAT0378',
'4111ODS49086',
'4111NOV08373',
'VB4325',
'41270401',
'4121ODS09306',
'MPS18113',
'6121MAI49685',
'2111PAI52474',
'2111RIA90952',
'4121PF027250',
'0111MUB31194',
'4121ROA51883',
'4121ODS48983',
'0111MUB76044',
'0111MUB11576',
'0121MUB03463',
'4111PF033480',
'4111GLS45454',
'0111MUB54419',
'4111STPE0269',
'5121ODS88491',
'2121PAI20656',
'4111ODS26180',
'4121RIA20821',
'4121BUG14406',
'5111MUB90387',
'4121RIA92336',
'6121MAI36716',
'7721MUB85837',
'0121MUB38426',
'2111PAI45806',
'4121ROA50190',
'0121MUB20906',
'4121ROA35594',
'4111ODS26293',
'4111BTM57321',
'0121MUB81590',
'0121MUB92964',
'4411MOA00951',
'NRS_UD342935',
'5111MAI49405',
'2111PAI20631',
'5111LIA02895',
'4121GLS45724',
'4121PAI38045',
'4721RIGA0492',
'4121ARCZ0037',
'0111GLS08068',
'0121MUB62336',
'5121MAI45890',
'0111MUB74195',
'2111PAI53459',
'47155914',
'0121MUB92965',
'4121RIA07040',
'4121TBI10074',
'7111PAI42930',
'1395793',
'4711RIA05025',
'8111BRZ78839',
'8121BRZ88429',
'4121ODS61054',
'0121MUB84855',
'0111MUMB0496',
'0121MUB52661',
'5121MUB94237',
'8111BRZ81921',
'8111BRZ80901',
'2121PAI20686',
'2111PAI68587',
'2111PAI50729',
'8111BRZ89743',
'4111GLS84283',
'4111ROA55601',
'4111GLS73060',
'8111BRZ71905',
'7121MUB84907',
'4121GDN53534',
'8111BRZ85778',
'7121BRZ71596',
'8121BRZ79364',
'8121BRZ71479',
'8111BRZ71598',
'8111BRZ74603',
'9711PF012863',
'2111PAI30603',
'SEL4-998551',
'4121ODS79773',
'8121BRZ88798',
'8121BRZ78766',
'8121BRZ86224',
'8111BRZ71437',
'8111BRZ85480',
'8111BRZ80238',
'4114ODS51541',
'0121MUB31983',
'4111PF026493',
'5121GLS83784',
'2111PAI72438',
'8111BRZ81922',
'5121MAI42797',
'8111BRZ81953',
'8121BRZ58523',
'2111PAI49239',
'2121PAI51622',
'4114RIA41584',
'2121PAI20652',
'4111GLS65540',
'4121BTM44640',
'4121GLS53452',
'4121GLS65828',
'6111MAI37538',
'8111BRZ82866',
'8121BRZ95772',
'4111NOO08617',
'2111PAI30886',
'2121GLS91486',
'5121SIG43024',
'7111BRZ76641',
'0111GLS97215',
'0121GLS97249',
'0121GLS97223',
'4121ODS08270',
'0111MUB89203',
'8111BRZ84658',
'I16606',
'8111BRZ71598',
'8111BRZ85778',
'8111BRZ91057',
'8121BRZ80130',
'0111GLS98240',
'8121BRZ72580',
'8121BRZ80941',
'8121BRZ79364')

),

[Planning History] AS (

SELECT
	PH.[Crew ID],
	PH.[Service Record ID],
	PH.[Planning Status Previous],
	PH.[Planning Status New],
	PH.[Planning History Updated On]

FROM 
	[ShipMgmt_Crewing].[tCrewPlanningHistory] PH
	INNER JOIN [Offsigners] Soff on Soff.[Crew ID] = ph.[Crew ID] --AND cast(PH.[Planning History Updated On] as date) BETWEEN cast(Soff.[Start Date] as date) AND cast(Soff.[End Date] as date))	

)

SELECT 
	FIN.*,
	/*CASE 
		WHEN FIN.[Planning Status New] = 'Cancelled' THEN 'Non-Compliant'
		WHEN FIN.[Planning Status New] = 'Released' THEN 'Non-Compliant'
		WHEN FIN.[Planning Status New] is NULL THEN 'Non-Compliant'
		ELSE 'Compliant' END AS [Onboard Planning Compliance]*/
	CASE 
		WHEN FIN.[Planning Status New] in ('Cancelled', 'Released') AND cast(fIn.[Planning History Updated On] as date) > cast(FIN.[Activity Date] as date) THEN 'Planning Cancelled prior disembarkation and planned after disembarkation'
		WHEN FIN.[Planning Status New] in ('Cancelled', 'Released') AND cast(fIn.[Planning History Updated On] as date) <= cast(FIN.[Activity Date] as date) THEN 'Planning Cancelled'
		WHEN FIN.[Planning Status New] in ('Planned', 'Approved', 'Plan Proposed', 'Proposed') AND cast(fIn.[Planning History Updated On] as date) >= cast(FIN.[Activity Date] as date) THEN 'Planned after disembarkation'
		WHEN cast(fIn.[Planning History Updated On] as date) BETWEEN cast(fin.[Start Date] as date) AND cast(fin.[End Date] as date)then 'within the service'
		WHEN cast(fIn.[Planning History Updated On] as date) > cast(FIN.[Activity Date] as date) THEN 'Planned After Disembarkation'
		WHEN 
	END AS [Possible Reason]
FROM (

		SELECT
		offs.*,
		plh.[Planning Status Previous],
		PLH.[Planning Status New],
		PLH.[Planning History Updated On],
		CASE WHEN plh.[Planning History Updated On] is null then 1 else 
			ROW_NUMBER ( )   
				OVER ( PARTITION BY offs.[Crew ID] order by  plh.[Planning History Updated On] desc) end as RN

		from Offsigners offs
		left join [Planning History] plh on (plh.[Crew ID] = offs.[Crew ID] --AND cast(plh.[Planning History Updated On] as date) BETWEEN cast(offs.[Start Date] as date) AND cast(offs.[End Date] as date))
		AND plh.[Service Record ID] <> offs.[Service Record ID])

) FIN
WHERE FIN.RN = 1